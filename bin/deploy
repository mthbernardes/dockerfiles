#!/bin/bash 

action=${1}

function docker_authentication(){
    if [[ -z ${DOCKER_PASSWORD} ]];then
        echo "Variable DOCKER_PASSWORD not set"
        exit 1
    fi

    if [[ -z ${DOCKER_LOGIN} ]];then
        echo "Variable DOCKER_LOGIN not set"
        exit 1
    fi

    echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_LOGIN --password-stdin
}

function docker_build_and_publish(){
    base_dir="$(dirname ${1})"
    image_name=$(basename ${base_dir})
    full_image_name="${DOCKER_LOGIN}/${image_name}"
    docker build -t "${full_image_name}" "${base_dir}"
    docker push "${full_image_name}"
}

function get_dockerfiles(){
    echo "NUMBER_BUILD: $CIRCLE_BUILD_NUM"
    if [[ "$CIRCLE_BUILD_NUM" -lt "1" ]]; then
        export dockerfiles="$(find images -name Dockerfile)"
    fi
    echo "URL: $CIRCLE_COMPARE_URL"
    if [[ ! -z "$CIRCLE_COMPARE_URL" ]]; then
        # CIRCLE_COMPARE_URL is not empty, use it to get the diff
        if [[ $CIRCLE_COMPARE_URL = *"commit"* ]]; then
            COMMIT_RANGE=$(echo $CIRCLE_COMPARE_URL | sed 's:^.*/commit/::g')~1
            echo $COMMIT_RANGE
        else
            COMMIT_RANGE=$(echo $CIRCLE_COMPARE_URL | sed 's:^.*/compare/::g')
            echo $COMMIT_RANGE
        fi
        echo "Diff: $COMMIT_RANGE"
        export dockerfiles="$(git diff $COMMIT_RANGE --name-only | grep 'images/' | cut -d '/' -f1,2 | uniq | xargs -I {} echo {}/Dockerfile)"
    fi
    echo $dockerfiles
}

if [[  ${action} =~ "build-and-publish" ]];then
    get_dockerfiles
    echo $dockerfiles
    for dockerfile in $dockerfiles;do
        docker_build_and_publish "${dockerfile}"
    done


elif [[ "${action}" =~ "authenticate" ]];then
    docker_authentication
fi

