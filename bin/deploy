#!/bin/bash -eo pipefail

action=${1}
DOCKER_PASSWORD="UBUaHCCvGEB84zbk-hMTSZUZWumiQrKe0MVWC37aXOfzHgkrYIWjs18NhwaOsAf57LryDhfFBu8zc7YQV-STg2Z8Ty9nPHh6OiZ4yGbm72DKG1z3i4Z65QDV0URLz4ns"
DOCKER_LOGIN="gtrsinfra"

function docker_authentication(){
    if [[ -z ${DOCKER_PASSWORD} ]];then
        echo "Variable DOCKER_PASSWORD not set"
        exit 1
    fi

    if [[ -z ${DOCKER_LOGIN} ]];then
        echo "Variable DOCKER_LOGIN not set"
        exit 1
    fi

    echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_LOGIN --password-stdin
}

function docker_build_and_publish(){
    base_dir="$(dirname ${1})"
    image_name=$(basename ${base_dir})
    full_image_name="${DOCKER_LOGIN}/${image_name}"
    docker build -t "${full_image_name}" "${base_dir}"
    docker push "${full_image_name}"
}

if [[  ${action} =~ "build-and-publish" ]];then
    dockerfiles="$(find images -name Dockerfile)"
    for dockerfile in $dockerfiles;do
        docker_build_and_publish "${dockerfile}"
    done

elif [[ "${action}" =~ "authenticate" ]];then
    docker_authentication
fi

